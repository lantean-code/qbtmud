@page "/search"
@layout OtherLayout

<div class="content-panel">
    <div class="content-panel__toolbar">
        <MudToolBar Gutters="false" Dense="true">
            @if (!DrawerOpen)
            {
                <MudIconButton Icon="@Icons.Material.Outlined.NavigateBefore" OnClick="NavigateBack" title="Back to torrent list" />
                <MudDivider Vertical="true" />
            }
            <MudDivider Vertical="true" />
            <MudText Class="pl-5 no-wrap">Search</MudText>
        </MudToolBar>
    </div>
    <div class="content-panel__body">
        <MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="ma-0 pa-0 content-panel__container">
            <MudMenu @ref="ResultContextMenu"
                     Dense="true"
                     RelativeWidth="DropdownWidth.Ignore"
                     PositionAtCursor="true"
                     ListClass="unselectable"
                     PopoverClass="unselectable">
                <MudMenuItem Icon="@Icons.Material.Filled.Download" Disabled="@( !HasContextResult )" OnClick="DownloadResultFromContext">Download</MudMenuItem>
                <MudMenuItem Icon="@Icons.Material.Filled.OpenInNew" Disabled="@( !HasContextResult )" OnClick="OpenDescriptionFromContext">Open description</MudMenuItem>
                <MudDivider />
                <MudMenuItem Icon="@Icons.Material.Filled.ContentCopy" Disabled="@( !HasContextResult )" OnClick="CopyNameFromContext">Copy name</MudMenuItem>
                <MudMenuItem Icon="@Icons.Material.Filled.ContentCopy" Disabled="@( !HasContextResult )" OnClick="CopyDownloadLinkFromContext">Copy download link</MudMenuItem>
                <MudMenuItem Icon="@Icons.Material.Filled.ContentCopy" Disabled="@( !HasContextResult )" OnClick="CopyDescriptionLinkFromContext">Copy description link</MudMenuItem>
            </MudMenu>

            <MudCard Elevation="1" Class="ml-4 mr-4 mb-4">
                <MudCardContent>
                    <EditForm Model="Model" OnValidSubmit="DoSearch">
                        <MudGrid>
                            <MudItem xs="12" md="4">
                                <MudTextField T="string"
                                              Label="Criteria"
                                              Variant="Variant.Outlined"
                                              @bind-Value="Model.SearchText" />
                            </MudItem>
                        <MudItem xs="12" md="3">
                                <MudSelect T="string"
                                           Label="Categories"
                                           Variant="Variant.Outlined"
                                           Value="@Model.SelectedCategory"
                                           ValueChanged="async value => await OnCategoryChanged(value)">
                                @foreach (var category in Categories)
                                {
                                    <MudSelectItem Value="category.Key">@category.Value</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="12" md="3">
                                <MudSelect T="string"
                                           Label="Plugins"
                                           Variant="Variant.Outlined"
                                           MultiSelection="true"
                                           SelectedValues="@Model.SelectedPlugins"
                                           SelectedValuesChanged="async values => await OnPluginsChanged(values)">
                                <MudSelectItem Value="@SearchForm.AllPluginsToken">All plugins</MudSelectItem>
                                <MudSelectItem Value="@SearchForm.EnabledPluginsToken">Enabled plugins</MudSelectItem>
                                <MudDivider />
                                @foreach (var (value, name) in Plugins)
                                {
                                    var pluginInfo = _plugins?.FirstOrDefault(p => string.Equals(p.Name, value, StringComparison.OrdinalIgnoreCase));
                                    <MudSelectItem Value="value" Disabled="@(pluginInfo is not null && !pluginInfo.Enabled)">@name</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="12" md="2">
                            <MudStack Spacing="1">
                                <MudButton ButtonType="ButtonType.Submit"
                                           FullWidth="true"
                                           Disabled="@(ActiveJob?.IsRunning == true ? false : !CanStartNewSearch)"
                                               Color="@(ActiveJob?.IsRunning == true ? Color.Error : Color.Primary)"
                                               EndIcon="@(ActiveJob?.IsRunning == true ? Icons.Material.Filled.Stop : Icons.Material.Filled.Search)"
                                               Variant="Variant.Filled">
                                        @(ActiveJob?.IsRunning == true ? "Stop job" : "Start search")
                                </MudButton>
                                <MudButton FullWidth="true"
                                           Color="Color.Secondary"
                                           Variant="Variant.Outlined"
                                           StartIcon="@Icons.Material.Filled.Settings"
                                           OnClick="ManagePlugins">
                                    Manage plugins
                                </MudButton>
                                <MudButton FullWidth="true"
                                           Variant="Variant.Text"
                                           StartIcon="@(ShowAdvancedFilters ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)"
                                           OnClick="ToggleAdvancedFilters">
                                    @(ShowAdvancedFilters ? "Hide filters" : "Show filters")
                                </MudButton>
                            </MudStack>
                        </MudItem>
                    </MudGrid>
                        <MudCollapse Expanded="ShowAdvancedFilters">
                            <MudGrid Class="mt-2">
                                <MudItem xs="12" md="4">
                                    <MudTextField T="string"
                                                  Label="Filter results"
                                                  Variant="Variant.Outlined"
                                                  Value="@Model.FilterText"
                                                  ValueChanged="async value => await OnFilterTextChanged(value)"
                                                  Immediate="true" />
                                </MudItem>
                                <MudItem xs="12" md="2">
                                    <MudSelect T="SearchInScope"
                                               Label="Search in"
                                               Variant="Variant.Outlined"
                                               Value="@Model.SearchIn"
                                               ValueChanged="async value => await OnSearchInChanged(value)">
                                        <MudSelectItem Value="SearchInScope.Everywhere">Everywhere</MudSelectItem>
                                        <MudSelectItem Value="SearchInScope.Names">Names only</MudSelectItem>
                                    </MudSelect>
                                </MudItem>
                                <MudItem xs="12" md="2">
                                    <MudNumericField T="int?"
                                                     Label="Min seeders"
                                                     Variant="Variant.Outlined"
                                                     Min="0"
                                                     Value="@Model.MinimumSeeds"
                                                     ValueChanged="async value => await OnMinimumSeedsChanged(value)"
                                                     Immediate="true" />
                                </MudItem>
                                <MudItem xs="12" md="2">
                                    <MudNumericField T="int?"
                                                     Label="Max seeders"
                                                     Variant="Variant.Outlined"
                                                     Min="0"
                                                     Value="@Model.MaximumSeeds"
                                                     ValueChanged="async value => await OnMaximumSeedsChanged(value)"
                                                     Immediate="true" />
                                </MudItem>
                            </MudGrid>
                            <MudGrid Class="mt-2">
                                <MudItem xs="12" md="3">
                                    <MudNumericField T="double?"
                                                     Label="Min size"
                                                     Variant="Variant.Outlined"
                                                     Min="0"
                                                     Value="@Model.MinimumSize"
                                                     ValueChanged="async value => await OnMinimumSizeChanged(value)"
                                                     Immediate="true" />
                                </MudItem>
                                <MudItem xs="12" md="1">
                                    <MudSelect T="SearchSizeUnit"
                                               Label="Unit"
                                               Variant="Variant.Outlined"
                                               Value="@Model.MinimumSizeUnit"
                                               ValueChanged="async value => await OnMinimumSizeUnitChanged(value)">
                                        @foreach (var option in SizeUnitOptionsList)
                                        {
                                            <MudSelectItem Value="option.Unit">@option.Label</MudSelectItem>
                                        }
                                    </MudSelect>
                                </MudItem>
                                <MudItem xs="12" md="3">
                                    <MudNumericField T="double?"
                                                     Label="Max size"
                                                     Variant="Variant.Outlined"
                                                     Min="0"
                                                     Value="@Model.MaximumSize"
                                                     ValueChanged="async value => await OnMaximumSizeChanged(value)"
                                                     Immediate="true" />
                                </MudItem>
                                <MudItem xs="12" md="1">
                                    <MudSelect T="SearchSizeUnit"
                                               Label="Unit"
                                               Variant="Variant.Outlined"
                                               Value="@Model.MaximumSizeUnit"
                                               ValueChanged="async value => await OnMaximumSizeUnitChanged(value)">
                                        @foreach (var option in SizeUnitOptionsList)
                                        {
                                            <MudSelectItem Value="option.Unit">@option.Label</MudSelectItem>
                                        }
                                    </MudSelect>
                                </MudItem>
                            </MudGrid>
                        </MudCollapse>
                </EditForm>
            </MudCardContent>
        </MudCard>

            @if (ShowSearchUnavailableMessage)
            {
                <MudAlert Severity="Severity.Error" Elevation="0" Class="ml-4 mr-4 mb-2">
                    @SearchUnavailableMessage
                </MudAlert>
            }
            else if (ShowNoPluginWarning)
            {
                <MudAlert Severity="Severity.Warning" Elevation="0" Class="ml-4 mr-4 mb-2">
                    Enable at least one search plugin to run searches.
                </MudAlert>
            }

            <MudPaper Elevation="0" Class="ml-4 mr-4 mb-2 pa-3">
                <MudStack Row="true" Spacing="1" Style="align-items:center;">
                    <MudButton Color="Color.Error"
                               Variant="Variant.Text"
                               StartIcon="@Icons.Material.Filled.Stop"
                               Disabled="@(ActiveJob?.IsRunning != true)"
                               OnClick="StopActiveJob">
                        Stop
                    </MudButton>
                    <MudButton Color="Color.Primary"
                               Variant="Variant.Text"
                               StartIcon="@Icons.Material.Filled.Refresh"
                               Disabled="@(ActiveJob is null)"
                               OnClick="RefreshActiveJob">
                        Refresh
                    </MudButton>
                    <MudButton Color="Color.Secondary"
                               Variant="Variant.Text"
                               StartIcon="@Icons.Material.Filled.Close"
                               Disabled="@(ActiveJob is null)"
                               OnClick="CloseActiveJob">
                        Close
                    </MudButton>
                    <MudButton Color="Color.Default"
                               Variant="Variant.Text"
                               StartIcon="@Icons.Material.Filled.Cancel"
                               Disabled="@(Jobs.Count == 0)"
                               OnClick="CloseAllJobs">
                        Close all
                    </MudButton>
                    <MudSpacer />
                    @if (ActiveJob is not null)
                    {
                        <MudChip T="string" Color="@GetJobStatusColor(ActiveJob)" Variant="Variant.Filled" Size="Size.Small">@ActiveJob.Status</MudChip>
                        <MudText Typo="Typo.caption" Class="ml-2">Results: @GetJobResultSummary(ActiveJob)</MudText>
                    }
                </MudStack>
            </MudPaper>

            @if (HasJobs)
            {
                <MudTabs Class="ml-4 mr-4 mb-4"
                         Border="true"
                         ApplyEffectsToContainer="true"
                         @bind-ActivePanelIndex="ActiveTabIndex">
                    @foreach (var job in Jobs)
                    {
                        <MudTabPanel>
                            <TabContent>
                                <div class="d-flex align-center">
                                    <MudIcon Icon="@GetJobStatusIcon(job)" Color="@GetJobStatusColor(job)" Size="Size.Small" Class="mr-1" />
                                    <MudText Typo="Typo.body2">@job.Pattern</MudText>
                                    <MudText Typo="Typo.caption" Class="ml-2">@GetJobResultSummary(job)</MudText>
                                </div>
                            </TabContent>
                            <ChildContent>
                                <MudStack Spacing="1" Class="pa-3">
                                    <MudText Typo="Typo.subtitle2">@job.Pattern</MudText>
                                    <MudText Typo="Typo.body2">Category: @job.Category</MudText>
                                    <MudText Typo="Typo.caption">Plugins: @string.Join(", ", job.Plugins)</MudText>
                                    <MudText Typo="Typo.caption">Status: @job.Status</MudText>
                                </MudStack>
                            </ChildContent>
                        </MudTabPanel>
                    }
                </MudTabs>
            }
            else
            {
                <MudPaper Elevation="0" Class="ml-4 mr-4 mb-4 pa-6 d-flex justify-center">
                    <MudStack Spacing="1" Class="text-center">
                        <MudIcon Icon="@Icons.Material.Filled.ManageSearch" Color="Color.Info" Size="Size.Large" />
                        <MudText Typo="Typo.subtitle1">No searches yet</MudText>
                        <MudText Typo="Typo.body2" Align="Align.Center">Run a search to start tracking jobs and see results here.</MudText>
                    </MudStack>
                </MudPaper>
            }

            <DynamicTable @ref="Table"
                          T="Lantean.QBitTorrentClient.Models.SearchResult"
                          ColumnDefinitions="Columns"
                          Items="Results"
                          MultiSelection="false"
                          SelectOnRowClick="false"
                          OnTableDataContextMenu="HandleResultContextMenu"
                          OnTableDataLongPress="HandleResultLongPress"
                          Class="search-list content-panel__table" />
        </MudContainer>
    </div>
</div>
