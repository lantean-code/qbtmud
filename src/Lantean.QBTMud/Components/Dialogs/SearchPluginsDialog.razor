@using Lantean.QBitTorrentClient.Models
@using Lantean.QBTMud.Components.UI

<MudDialog Class="search-plugins-dialog">
    <DialogContent>
        @if (IsBusy)
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-4" />
        }
        <MudGrid Class="mb-4" Spacing="2">
            <MudItem xs="12" md="6">
                <MudPaper Class="pa-4">
                    <MudText Typo="Typo.subtitle2" Class="mb-2">@LanguageLocalizer.Translate("AppTemp", "Install from URL")</MudText>
                    <MudTextField @bind-Value="InstallUrl"
                                  Placeholder="@LanguageLocalizer.Translate("AppTemp", "https://example.com/plugin.zip")"
                                  Variant="Variant.Outlined"
                                  Disabled="OperationInProgress"
                                  Immediate="true"
                                  data-test-id="@TestIdHelper.For("SearchPluginInstallUrl")" />
                    <MudButton Color="Color.Success"
                               Variant="Variant.Filled"
                               Disabled="OperationInProgress || string.IsNullOrWhiteSpace(InstallUrl)"
                               OnClick="InstallFromUrl"
                               Class="mt-3"
                               StartIcon="@Icons.Material.Filled.CloudDownload"
                               data-test-id="@TestIdHelper.For("SearchPluginInstallUrlButton")">@LanguageLocalizer.Translate("PluginSourceDlg", "Install plugin")</MudButton>
                </MudPaper>
            </MudItem>
            <MudItem xs="12" md="6">
                <MudPaper Class="pa-4">
                    <MudText Typo="Typo.subtitle2" Class="mb-2">@LanguageLocalizer.Translate("AppTemp", "Install from server path")</MudText>
                    <PathAutocomplete Label="@LanguageLocalizer.Translate("PluginSourceDlg", "Plugin path:")"
                                      @bind-Value="InstallLocalPath"
                                      Placeholder="@LanguageLocalizer.Translate("AppTemp", "/home/qbt/plugins/my-plugin.py")"
                                      Mode="DirectoryContentMode.All"
                                      AllowFolderSelection="false"
                                      Disabled="OperationInProgress"
                                      Immediate="true"
                                      data-test-id="@TestIdHelper.For("SearchPluginInstallPath")" />
                    <MudButton Color="Color.Success"
                               Variant="Variant.Filled"
                               Disabled="OperationInProgress || string.IsNullOrWhiteSpace(InstallLocalPath)"
                               OnClick="InstallFromPath"
                               Class="mt-3"
                               StartIcon="@Icons.Material.Filled.UploadFile"
                               data-test-id="@TestIdHelper.For("SearchPluginInstallPathButton")">@LanguageLocalizer.Translate("PluginSourceDlg", "Install plugin")</MudButton>
                </MudPaper>
            </MudItem>
        </MudGrid>
        <MudPaper Class="pa-3 mb-3">
            <MudStack Row="true" Spacing="2">
                <MudButton Variant="Variant.Filled"
                           Color="Color.Success"
                           Disabled="!HasSelection || OperationInProgress"
                           StartIcon="@Icons.Material.Filled.ToggleOn"
                           OnClick="EnableSelected"
                           data-test-id="@TestIdHelper.For("SearchPluginEnable")">@LanguageLocalizer.Translate("AppTemp", "Enable")</MudButton>
                <MudButton Variant="Variant.Filled"
                           Color="Color.Default"
                           Disabled="!HasSelection || OperationInProgress"
                           StartIcon="@Icons.Material.Filled.ToggleOff"
                           OnClick="DisableSelected"
                           data-test-id="@TestIdHelper.For("SearchPluginDisable")">@LanguageLocalizer.Translate("AppTemp", "Disable")</MudButton>
                <MudButton Variant="Variant.Filled"
                           Color="Color.Default"
                           Disabled="!HasSelection || OperationInProgress"
                           StartIcon="@Icons.Material.Filled.Delete"
                           OnClick="UninstallSelected"
                           data-test-id="@TestIdHelper.For("SearchPluginUninstall")">@LanguageLocalizer.Translate("PluginSelectDlg", "Uninstall")</MudButton>
                <MudButton Variant="Variant.Filled"
                           Color="Color.Default"
                           Disabled="OperationInProgress || Plugins.Count == 0"
                           StartIcon="@Icons.Material.Filled.Update"
                           OnClick="UpdateAll"
                           data-test-id="@TestIdHelper.For("SearchPluginUpdateAll")">@LanguageLocalizer.Translate("PluginSelectDlg", "Check for updates")</MudButton>
                <MudSpacer />
                <Tooltip Text="@LanguageLocalizer.Translate("AppTemp", "Refresh plugins")">
                    <MudIconButton Icon="@Icons.Material.Filled.Refresh"
                                   Color="Color.Default"
                                   Disabled="OperationInProgress"
                                   OnClick="RefreshPlugins"
                                   data-test-id="@TestIdHelper.For("SearchPluginRefresh")" />
                </Tooltip>
            </MudStack>
        </MudPaper>
        <MudTable T="Lantean.QBitTorrentClient.Models.SearchPlugin"
                  Items="Plugins"
                  Hover="true"
                  Bordered="true"
                  Dense="true">
            <HeaderContent>
                <MudTh>@LanguageLocalizer.Translate("AppTemp", "Select")</MudTh>
                <MudTh>@LanguageLocalizer.Translate("SearchPluginsTable", "Enabled")</MudTh>
                <MudTh>@LanguageLocalizer.Translate("SearchPluginsTable", "Name")</MudTh>
                <MudTh>@LanguageLocalizer.Translate("AppTemp", "Identifier")</MudTh>
                <MudTh>@LanguageLocalizer.Translate("SearchPluginsTable", "Version")</MudTh>
                <MudTh>@LanguageLocalizer.Translate("AppTemp", "Last update")</MudTh>
                <MudTh>@LanguageLocalizer.Translate("SearchPluginsTable", "Url")</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="@LanguageLocalizer.Translate("AppTemp", "Select")">
                    <MudIconButton Icon="@GetSelectionIcon(context)"
                                   Color="@GetSelectionColor(context)"
                                   Disabled="OperationInProgress"
                                   OnClick="@(() => ToggleSelection(context))"
                                   data-test-id="@TestIdHelper.For($"SearchPluginSelect-{context.Name}")" />
                </MudTd>
                <MudTd DataLabel="@LanguageLocalizer.Translate("SearchPluginsTable", "Enabled")">
                    <MudIconButton Icon="@GetEnabledIcon(context)"
                                   Color="@GetEnabledColor(context)"
                                   Disabled="OperationInProgress"
                                   OnClick="@(() => TogglePlugin(context, !context.Enabled))"
                                   data-test-id="@TestIdHelper.For($"SearchPluginToggle-{context.Name}")" />
                </MudTd>
                <MudTd DataLabel="@LanguageLocalizer.Translate("SearchPluginsTable", "Name")">
                    <MudText Typo="Typo.body2">@context.FullName</MudText>
                </MudTd>
                <MudTd DataLabel="@LanguageLocalizer.Translate("AppTemp", "Identifier")">
                    <MudChip T="string" Color="Color.Secondary" Variant="Variant.Outlined" Size="Size.Small">@context.Name</MudChip>
                </MudTd>
                <MudTd DataLabel="@LanguageLocalizer.Translate("SearchPluginsTable", "Version")">@context.Version</MudTd>
                <MudTd DataLabel="@LanguageLocalizer.Translate("AppTemp", "Last update")">@GetLastUpdatedText(context)</MudTd>
                <MudTd DataLabel="@LanguageLocalizer.Translate("SearchPluginsTable", "Url")">
                    @if (string.IsNullOrWhiteSpace(context.Url))
                    {
                        <MudText Typo="Typo.caption">@LanguageLocalizer.Translate("AppTemp", "Not provided")</MudText>
                    }
                    else
                    {
                        <MudLink Href="@context.Url" Target="_blank">@context.Url</MudLink>
                    }
                </MudTd>
            </RowTemplate>
            <NoRecordsContent>
                <MudText Typo="Typo.subtitle2" Class="pa-4">@LanguageLocalizer.Translate("SearchEngineWidget", "There aren't any search plugins installed.")</MudText>
            </NoRecordsContent>
        </MudTable>
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Filled" Color="Color.Success" OnClick="CloseDialog" data-test-id="@TestIdHelper.For("SearchPluginClose")">@LanguageLocalizer.Translate("PluginSelectDlg", "Close")</MudButton>
    </DialogActions>
</MudDialog>
