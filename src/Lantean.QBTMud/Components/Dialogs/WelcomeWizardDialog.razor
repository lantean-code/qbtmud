@using Lantean.QBTMud.Models
@using Lantean.QBTMud.Services.Localization
@using Lantean.QBTMud.Services
@using Lantean.QBTMud.Helpers

<MudDialog Class="welcome-wizard-dialog"
           ContentClass="welcome-wizard-dialog__content"
           data-test-id="@TestIdHelper.For($"WelcomeWizardDialog-{GetStepTitle(IntroStepToken)}")">
    <DialogContent>
        <div class="welcome-wizard-dialog__layout">
            <MudStepper @bind-ActiveIndex="_activeIndex"
                        CurrentStepColor="@GetCurrentStepAccentColor()"
                        NonLinear="true"
                        CenterLabels="true"
                        data-test-id="@TestIdHelper.For($"WelcomeWizardStepper-{IsCurrentIntroStep}-{IsCurrentLanguageStep}-{IsCurrentThemeStep}-{IsCurrentNotificationsStep}-{IsCurrentDoneStep}")">
                <ChildContent>
                    @foreach (var stepToken in FlowSteps)
                    {
                        <MudStep Title="@GetStepTitle(stepToken)" Class="welcome-wizard-dialog__step-pane">
                            @if (string.Equals(stepToken, "__intro__", StringComparison.Ordinal))
                            {
                                <MudStack Class="mud-height-full" data-test-id="@TestIdHelper.For("WelcomeWizardIntroCard")">
                                    <WizardStep Accent="@WizardAccentColor.FromPalette(Color.Info)"
                                                Icon="@Icons.Material.Filled.WavingHand"
                                                Title="@LanguageLocalizer.Translate("AppWelcomeWizard", "Welcome back")"
                                                Subtitle="@LanguageLocalizer.Translate("AppWelcomeWizard", "Welcome back to qbtmud. We've added new setup options for you.")"
                                                AlertSeverity="Severity.Info"
                                                AlertText="@LanguageLocalizer.Translate("AppWelcomeWizard", "Review the new options and finish when you're ready.")" />
                                </MudStack>
                            }
                            else if (string.Equals(stepToken, WelcomeWizardStepCatalog.LanguageStepId, StringComparison.Ordinal))
                            {
                                <WizardStep Accent="@WizardAccentColor.FromPalette(Color.Info)"
                                            Icon="@Icons.Material.Filled.Language"
                                            Title="@LanguageLocalizer.Translate("OptionsDialog", "Language")"
                                            Subtitle="@LanguageLocalizer.Translate("AppWelcomeWizard", "Thanks for using qbtmud. Choose your language to get started.")"
                                            AlertSeverity="Severity.Info"
                                            AlertText="@LanguageLocalizer.Translate("AppWelcomeWizard", "Changing language updates qBittorrent preferences and applies immediately in this session.")">
                                    <MudSelect T="string"
                                               Label="@LanguageLocalizer.Translate("OptionsDialog", "User interface language:")"
                                               Value="_selectedLocale"
                                               ValueChanged="OnLocaleChanged"
                                               ToStringFunc="GetLanguageDisplayName"
                                               Variant="Variant.Outlined"
                                               ShrinkLabel="true"
                                               Dense="true"
                                               FullWidth="true"
                                               data-test-id="@TestIdHelper.For("WelcomeWizardLanguageSelect")">
                                        @foreach (var language in _languageOptions)
                                        {
                                            <MudSelectItem Value="@language.Code">@language.DisplayName</MudSelectItem>
                                        }
                                    </MudSelect>
                                </WizardStep>
                            }
                            else if (string.Equals(stepToken, WelcomeWizardStepCatalog.ThemeStepId, StringComparison.Ordinal))
                            {
                                <WizardStep Accent="@WizardAccentColor.FromPalette(Color.Primary)"
                                            Icon="@Icons.Material.Filled.Palette"
                                            Title="@LanguageLocalizer.Translate("AppThemes", "Theme")"
                                            Subtitle="@LanguageLocalizer.Translate("AppWelcomeWizard", "Choose a theme. It will apply immediately so you can preview it.")"
                                            AlertSeverity="Severity.Info"
                                            AlertText="@LanguageLocalizer.Translate("AppWelcomeWizard", "Choose a theme. It will apply immediately so you can preview it.")">
                                    <MudSelect T="string"
                                               Label="@LanguageLocalizer.Translate("AppThemes", "Theme")"
                                               Value="_selectedThemeId"
                                               ValueChanged="OnThemeChanged"
                                               ToStringFunc="GetThemeDisplayName"
                                               Variant="Variant.Outlined"
                                               ShrinkLabel="true"
                                               Dense="true"
                                               FullWidth="true"
                                               data-test-id="@TestIdHelper.For("WelcomeWizardThemeSelect")">
                                        @foreach (var theme in _themeOptions)
                                        {
                                            <MudSelectItem Value="@theme.Id">@theme.Name</MudSelectItem>
                                        }
                                    </MudSelect>
                                </WizardStep>
                            }
                            else if (string.Equals(stepToken, WelcomeWizardStepCatalog.NotificationsStepId, StringComparison.Ordinal))
                            {
                                <WizardStep Accent="@WizardAccentColor.FromPalette(Color.Warning)"
                                            Icon="@Icons.Material.Filled.Notifications"
                                            Title="@LanguageLocalizer.Translate("AppNotifications", "Notifications")"
                                            Subtitle="@LanguageLocalizer.Translate("AppWelcomeWizard", "Enable browser notifications and choose which events trigger alerts.")">
                                    <MudGrid>
                                        <MudItem xs="12">
                                            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Wrap="Wrap.Wrap" Spacing="2">
                                                <FieldSwitch Value="@_settings.NotificationsEnabled"
                                                             ValueChanged="OnNotificationsEnabledChanged"
                                                             Label="@LanguageLocalizer.Translate("AppNotifications", "Enable browser notifications")"
                                                             data-test-id="@TestIdHelper.For("WelcomeWizardNotificationsEnabled")" />

                                                <MudChip T="string"
                                                         Color="@GetNotificationPermissionColor()"
                                                         Variant="Variant.Outlined"
                                                         data-test-id="@TestIdHelper.For("WelcomeWizardNotificationPermission")">
                                                    @LanguageLocalizer.Translate("AppNotifications", "Permission: %1", GetNotificationPermissionText())
                                                </MudChip>
                                            </MudStack>
                                        </MudItem>

                                        @if (_settings.NotificationsEnabled)
                                        {
                                            <MudItem xs="12">
                                                <MudText Typo="Typo.body2" Class="fw-bold mb-2">@LanguageLocalizer.Translate("AppNotifications", "Browser notification types")</MudText>
                                                <MudStack Spacing="1">
                                                    <MudCheckBox T="bool"
                                                                 Value="@_settings.DownloadFinishedNotificationsEnabled"
                                                                 ValueChanged="OnDownloadFinishedNotificationsChanged"
                                                                 Disabled="@_isApplyingNotificationToggle"
                                                                 Label="@LanguageLocalizer.Translate("AppNotifications", "Download completed")"
                                                                 data-test-id="@TestIdHelper.For("WelcomeWizardDownloadFinishedNotificationsEnabled")" />
                                                    <MudCheckBox T="bool"
                                                                 Value="@_settings.TorrentAddedNotificationsEnabled"
                                                                 ValueChanged="OnTorrentAddedNotificationsChanged"
                                                                 Disabled="@_isApplyingNotificationToggle"
                                                                 Label="@LanguageLocalizer.Translate("AppNotifications", "Torrent added")"
                                                                 data-test-id="@TestIdHelper.For("WelcomeWizardTorrentAddedNotificationsEnabled")" />
                                                </MudStack>
                                            </MudItem>

                                            @if (_settings.TorrentAddedNotificationsEnabled)
                                            {
                                                <MudItem xs="12">
                                                    <FieldSwitch Value="@_settings.TorrentAddedSnackbarsEnabledWithNotifications"
                                                                 ValueChanged="OnTorrentAddedSnackbarsWithNotificationsChanged"
                                                                 Label="@LanguageLocalizer.Translate("AppNotifications", "Show add-torrent snackbars when browser notifications are enabled")"
                                                                 Disabled="@_isApplyingNotificationToggle"
                                                                 data-test-id="@TestIdHelper.For("WelcomeWizardTorrentAddedSnackbarsEnabledWithNotifications")" />
                                                </MudItem>
                                            }
                                        }
                                    </MudGrid>
                                </WizardStep>
                            }
                            else
                            {
                                <WizardStep Accent="@WizardAccentColor.FromPalette(Color.Success)"
                                            Icon="@Icons.Material.Filled.CheckCircle"
                                            Title="@LanguageLocalizer.Translate("AppWelcomeWizard", "Setup complete")"
                                            Subtitle="@LanguageLocalizer.Translate("AppWelcomeWizard", "Your preferences are saved. You can change them anytime.")">
                                    <MudStack Spacing="2">
                                        <MudStack Row="true" Wrap="Wrap.Wrap" Justify="Justify.Center" Spacing="1">
                                            @if (FlowSteps.Contains(WelcomeWizardStepCatalog.LanguageStepId, StringComparer.Ordinal) && !string.IsNullOrWhiteSpace(SelectedLanguageName))
                                            {
                                                <MudChip T="string" Variant="Variant.Outlined" Color="Color.Success" data-test-id="@TestIdHelper.For("WelcomeWizardDoneLanguageChip")">
                                                    @LanguageLocalizer.Translate("AppWelcomeWizard", "Language: %1", SelectedLanguageName)
                                                </MudChip>
                                            }

                                            @if (FlowSteps.Contains(WelcomeWizardStepCatalog.ThemeStepId, StringComparer.Ordinal) && !string.IsNullOrWhiteSpace(SelectedThemeName))
                                            {
                                                <MudChip T="string" Variant="Variant.Outlined" Color="Color.Success" data-test-id="@TestIdHelper.For("WelcomeWizardDoneThemeChip")">
                                                    @LanguageLocalizer.Translate("AppWelcomeWizard", "Theme: %1", SelectedThemeName)
                                                </MudChip>
                                            }

                                            @if (FlowSteps.Contains(WelcomeWizardStepCatalog.NotificationsStepId, StringComparer.Ordinal))
                                            {
                                                <MudChip T="string"
                                                         Variant="Variant.Outlined"
                                                         Color="Color.Success"
                                                         data-test-id="@TestIdHelper.For("WelcomeWizardDoneNotificationsChip")"
                                                         data-test-summary-color="@GetNotificationSummaryColor()">
                                                    @LanguageLocalizer.Translate("AppWelcomeWizard", "Notifications: %1", GetNotificationSummaryText())
                                                </MudChip>
                                            }
                                        </MudStack>

                                        <MudText Typo="Typo.subtitle2" Class="mb-2">@LanguageLocalizer.Translate("AppWelcomeWizard", "Next steps")</MudText>
                                        <MudGrid Spacing="2">
                                            <MudItem xs="12" sm="6">
                                                <div class="welcome-wizard-dialog__next-cell">
                                                    <MudPaper Outlined="true" Class="pa-3" Style="height: 100%; width: 100%;">
                                                        <MudStack Spacing="1">
                                                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                                                <MudIcon Icon="@Icons.Material.Outlined.Settings" />
                                                                <MudText Typo="Typo.subtitle2">@LanguageLocalizer.Translate("OptionsDialog", "Options")</MudText>
                                                            </MudStack>
                                                            <MudText Typo="Typo.body2">
                                                                @LanguageLocalizer.Translate("AppWelcomeWizard", "Open Options from the sidebar to configure the app.")
                                                            </MudText>
                                                            <MudButton Variant="Variant.Filled"
                                                                       Color="Color.Default"
                                                                       StartIcon="@Icons.Material.Outlined.Settings"
                                                                       OnClick="OnOpenOptionsClicked"
                                                                       data-test-id="@TestIdHelper.For("WelcomeWizardOpenOptions")">
                                                                @LanguageLocalizer.Translate("AppWelcomeWizard", "Open Options")
                                                            </MudButton>
                                                        </MudStack>
                                                    </MudPaper>
                                                </div>
                                            </MudItem>
                                            <MudItem xs="12" sm="6">
                                                <div class="welcome-wizard-dialog__next-cell">
                                                    <MudPaper Outlined="true" Class="pa-3" Style="height: 100%; width: 100%;">
                                                        <MudStack Spacing="1">
                                                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                                                <MudIcon Icon="@Icons.Material.Filled.MoreVert" />
                                                                <MudText Typo="Typo.subtitle2">@LanguageLocalizer.Translate("AppWelcomeWizard", "App menu")</MudText>
                                                            </MudStack>
                                                            <MudText Typo="Typo.body2">
                                                                @LanguageLocalizer.Translate("AppWelcomeWizard", "Use the 3-dots menu at the top right for quick actions.")
                                                            </MudText>
                                                        </MudStack>
                                                    </MudPaper>
                                                </div>
                                            </MudItem>
                                        </MudGrid>
                                    </MudStack>
                                </WizardStep>
                            }
                        </MudStep>
                    }
                </ChildContent>

                <ActionContent Context="stepper">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="w-100">
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Default"
                                   Disabled="@(_activeIndex == 0)"
                                   OnClick="OnBackClicked"
                                   data-test-id="@TestIdHelper.For("WelcomeWizardBack")">
                            @LanguageLocalizer.Translate("AppWelcomeWizard", "Back")
                        </MudButton>

                        @if (_activeIndex < LastStepIndex)
                        {
                            <MudButton Color="Color.Default"
                                       Variant="Variant.Filled"
                                       OnClick="OnNextClicked"
                                       data-test-id="@TestIdHelper.For("WelcomeWizardNext")">
                                @LanguageLocalizer.Translate("AppWelcomeWizard", "Next")
                            </MudButton>
                        }
                        else
                        {
                            <MudButton Color="Color.Success"
                                       Variant="Variant.Filled"
                                       OnClick="OnFinishClicked"
                                       data-test-id="@TestIdHelper.For("WelcomeWizardFinish")">
                                @LanguageLocalizer.Translate("AppWelcomeWizard", "Finish")
                            </MudButton>
                        }
                    </MudStack>
                </ActionContent>
            </MudStepper>
        </div>
    </DialogContent>
</MudDialog>
