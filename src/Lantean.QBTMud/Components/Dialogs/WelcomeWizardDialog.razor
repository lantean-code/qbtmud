@using Lantean.QBTMud.Models
@using Lantean.QBTMud.Services.Localization
@using Microsoft.AspNetCore.Components.Web

@inject Lantean.QBitTorrentClient.IApiClient ApiClient
@inject IWebUiLanguageCatalog WebUiLanguageCatalog
@inject IWebUiLocalizer WebUiLocalizer
@inject Lantean.QBTMud.Services.ILocalStorageService LocalStorage
@inject Lantean.QBTMud.Services.IThemeManagerService ThemeManagerService
@inject MudBlazor.ISnackbar Snackbar

<MudDialog ContentClass="welcome-wizard-dialog__content">
    <DialogContent>
        <MudText Typo="Typo.h6" Class="mb-2">@WebUiLocalizer.Translate("AppWelcomeWizard", "Welcome")</MudText>

        <MudStepper @bind-ActiveIndex="_activeIndex" NonLinear="true" CenterLabels="true" ActionContent="StepperActions">
            <MudStep Title="@WebUiLocalizer.Translate("OptionsDialog", "Language")">
                <MudText Typo="Typo.body1" Class="mb-4">
                    @WebUiLocalizer.Translate("AppWelcomeWizard", "Thanks for using qbtmud. Choose your language to get started.")
                </MudText>

                <MudSelect T="string"
                           Label="@WebUiLocalizer.Translate("OptionsDialog", "User interface language:")"
                           Value="_selectedLocale"
                           ValueChanged="OnLocaleChanged"
                           Variant="Variant.Outlined"
                           ShrinkLabel="true"
                           Dense="true">
                    @foreach (var language in _languageOptions)
                    {
                        <MudSelectItem Value="@language.Code">@language.DisplayName</MudSelectItem>
                    }
                </MudSelect>

                <MudAlert Severity="Severity.Info" Class="mt-4">
                    @WebUiLocalizer.Translate("AppWelcomeWizard", "Changing language updates qBittorrent preferences and applies immediately in this session.")
                </MudAlert>
            </MudStep>

            <MudStep Title="@WebUiLocalizer.Translate("AppThemes", "Theme")">
                <MudText Typo="Typo.body1" Class="mb-4">
                    @WebUiLocalizer.Translate("AppWelcomeWizard", "Choose a theme. It will apply immediately so you can preview it.")
                </MudText>

                <MudSelect T="string"
                           Label="@WebUiLocalizer.Translate("AppThemes", "Theme")"
                           Value="_selectedThemeId"
                           ValueChanged="OnThemeChanged"
                           Variant="Variant.Outlined"
                           ShrinkLabel="true"
                           Dense="true">
                    @foreach (var theme in _themeOptions)
                    {
                        <MudSelectItem Value="@theme.Id">@theme.Name</MudSelectItem>
                    }
                </MudSelect>
            </MudStep>

            <MudStep Title="@WebUiLocalizer.Translate("AppWelcomeWizard", "Done")">
                <MudText Typo="Typo.body1" Class="mb-2">
                    @WebUiLocalizer.Translate("AppWelcomeWizard", "You're all set.")
                </MudText>
                <MudText Typo="Typo.body2" Class="mb-2">
                    @WebUiLocalizer.Translate("AppWelcomeWizard", "For more settings, open Options from the sidebar.")
                </MudText>
                <MudText Typo="Typo.body2">
                    @WebUiLocalizer.Translate("AppWelcomeWizard", "App controls are in the 3-dots menu at the top right.")
                </MudText>
            </MudStep>
        </MudStepper>
    </DialogContent>
</MudDialog>

@code {
    private int _activeIndex;
    private string _selectedLocale = "en";
    private string? _selectedThemeId;
    private IReadOnlyList<WebUiLanguageCatalogItem> _languageOptions = Array.Empty<WebUiLanguageCatalogItem>();
    private IReadOnlyList<ThemeCatalogItem> _themeOptions = Array.Empty<ThemeCatalogItem>();

    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = default!;

    [Parameter]
    public string? InitialLocale { get; set; }

    private RenderFragment<MudStepper> StepperActions => stepper => builder =>
    {
        builder.OpenComponent<MudButton>(0);
        builder.AddAttribute(1, nameof(MudButton.Variant), Variant.Text);
        builder.AddAttribute(2, nameof(MudButton.Disabled), _activeIndex == 0);
        builder.AddAttribute(3, nameof(MudButton.OnClick), EventCallback.Factory.Create<MouseEventArgs>(this, _ => PreviousStep()));
        builder.AddAttribute(4, nameof(MudButton.ChildContent), (RenderFragment)(b => b.AddContent(5, WebUiLocalizer.Translate("AppWelcomeWizard", "Back"))));
        builder.CloseComponent();

        builder.OpenComponent<MudSpacer>(10);
        builder.CloseComponent();

        if (_activeIndex < 2)
        {
            builder.OpenComponent<MudButton>(20);
            builder.AddAttribute(21, nameof(MudButton.Color), Color.Primary);
            builder.AddAttribute(22, nameof(MudButton.Variant), Variant.Filled);
            builder.AddAttribute(23, nameof(MudButton.OnClick), EventCallback.Factory.Create<MouseEventArgs>(this, _ => NextStep()));
            builder.AddAttribute(24, nameof(MudButton.ChildContent), (RenderFragment)(b => b.AddContent(25, WebUiLocalizer.Translate("AppWelcomeWizard", "Next"))));
            builder.CloseComponent();
        }
        else
        {
            builder.OpenComponent<MudButton>(30);
            builder.AddAttribute(31, nameof(MudButton.Color), Color.Success);
            builder.AddAttribute(32, nameof(MudButton.Variant), Variant.Filled);
            builder.AddAttribute(33, nameof(MudButton.OnClick), EventCallback.Factory.Create<MouseEventArgs>(this, _ => Finish()));
            builder.AddAttribute(34, nameof(MudButton.ChildContent), (RenderFragment)(b => b.AddContent(35, WebUiLocalizer.Translate("AppWelcomeWizard", "Finish"))));
            builder.CloseComponent();
        }
    };
}

