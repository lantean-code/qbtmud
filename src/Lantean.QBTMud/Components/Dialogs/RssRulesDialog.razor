@using Lantean.QBitTorrentClient.Models
@using Lantean.QBTMud.Components.UI

<MudDialog>
    <DialogContent>
        <MudGrid>
            <MudItem xs="3">
                <MudToolBar Class="px-0" Dense>
                    <MudText Class="no-wrap">Download Rules</MudText>
                    <MudSpacer />
                    <MudIconButton Icon="@Icons.Material.Filled.Add" OnClick="AddRule" data-test-id="@TestIdHelper.For("RssRulesAdd")" />
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" OnClick="RemoveRule" Disabled="SelectedRuleName is null" data-test-id="@TestIdHelper.For("RssRulesRemove")" />
                </MudToolBar>

                <MudList T="string" SelectionMode="SelectionMode.SingleSelection" SelectedValue="SelectedRuleName" SelectedValueChanged="SelectedRuleChanged" data-test-id="@TestIdHelper.For("RssRulesList")">
                    @foreach (var (ruleName, rule) in Rules)
                    {
                        <MudListItem Icon="@((rule?.Enabled ?? true) ? Icons.Material.Filled.CheckBox : Icons.Material.Filled.CheckBoxOutlineBlank)" Text="@ruleName" Value="@ruleName" data-test-id="@TestIdHelper.For($"RssRule-{ruleName}")" />
                    }
                </MudList>
            </MudItem>
            <MudItem xs="6">
                <MudGrid>
                    <MudItem xs="12">
                        <FieldSwitch Label="Use regular expressions" Value="UseRegex" ValueChanged="UseRegexChanged" Disabled="@(SelectedRuleName is null)" data-test-id="@TestIdHelper.For("RssRulesUseRegex")" />
                    </MudItem>
                    <MudItem xs="12">
                        <MudTextField T="string" Label="Must contain" Value="MustContain" ValueChanged="MustContainChanged" Disabled="@(SelectedRuleName is null)" Variant="Variant.Outlined" ShrinkLabel="true" data-test-id="@TestIdHelper.For("RssRulesMustContain")" />
                    </MudItem>
                    <MudItem xs="12">
                        <MudTextField T="string" Label="Must not contain" Value="MustNotContain" ValueChanged="MustNotContainChanged" Disabled="@(SelectedRuleName is null)" Variant="Variant.Outlined" ShrinkLabel="true" data-test-id="@TestIdHelper.For("RssRulesMustNotContain")" />
                    </MudItem>
                    <MudItem xs="12">
                        <MudTextField T="string" Label="Episode filter" Value="EpisodeFilter" ValueChanged="EpisodeFilterChanged" Disabled="@(SelectedRuleName is null)" Variant="Variant.Outlined" ShrinkLabel="true" data-test-id="@TestIdHelper.For("RssRulesEpisodeFilter")" />
                    </MudItem>
                    <MudItem xs="12">
                        <FieldSwitch Label="Use smart episode filter" Value="SmartFilter" ValueChanged="SmartFilterChanged" Disabled="@(SelectedRuleName is null)" data-test-id="@TestIdHelper.For("RssRulesSmartFilter")" />
                    </MudItem>
                    <MudDivider />
                    <MudItem xs="12">
                        <MudSelect T="string" Label="Assign category" Value="Category" ValueChanged="CategoryChanged" Disabled="@(SelectedRuleName is null)" Variant="Variant.Outlined" ShrinkLabel="true" data-test-id="@TestIdHelper.For("RssRulesCategory")">
                            <MudSelectItem Value="@("")"></MudSelectItem>
                            @foreach (var category in Categories)
                            {
                                <MudSelectItem Value="@category">@category</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="12">
                        <MudTextField T="string" Label="Add tags" Value="Tags" ValueChanged="TagsChanged" Disabled="@(SelectedRuleName is null)" Variant="Variant.Outlined" ShrinkLabel="true" data-test-id="@TestIdHelper.For("RssRulesTags")" />
                    </MudItem>
                    <MudItem xs="12">
                        <FieldSwitch Label="Save to a different directory" Value="SaveToDifferentDirectory" ValueChanged="SaveToDifferentDirectoryChanged" Disabled="@(SelectedRuleName is null)" data-test-id="@TestIdHelper.For("RssRulesSaveToDifferentDirectory")" />
                    </MudItem>
                    <MudItem xs="12">
                        <PathAutocomplete Label="Save to"
                                          Value="@SaveTo"
                                          ValueChanged="@(value => SaveToChanged(value ?? string.Empty))"
                                          Mode="DirectoryContentMode.Directories"
                                          Disabled="@(SelectedRuleName is null || !SaveToDifferentDirectory)"
                                          data-test-id="@TestIdHelper.For("RssRulesSaveTo")" />
                    </MudItem>
                    <MudItem xs="12">
                        <MudNumericField T="int" Label="Ignore Subsequent Matches for (0 to Disable)" Value="IgnoreDays" ValueChanged="IgnoreDaysChanged" Disabled="@(SelectedRuleName is null)" Variant="Variant.Outlined" ShrinkLabel="true" data-test-id="@TestIdHelper.For("RssRulesIgnoreDays")" />
                    </MudItem>
                    <MudItem xs="12">
                        <MudSelect T="string" Label="Add stopped" Value="AddStopped" ValueChanged="AddStoppedChanged" Disabled="@(SelectedRuleName is null)" Variant="Variant.Outlined" ShrinkLabel="true" data-test-id="@TestIdHelper.For("RssRulesAddStopped")">
                            <MudSelectItem Value="@("default")">Use global settings</MudSelectItem>
                            <MudSelectItem Value="@("always")">Always</MudSelectItem>
                            <MudSelectItem Value="@("never")">Never</MudSelectItem>
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="12">
                        <MudSelect T="string" Label="Torrent content layout" Value="ContentLayout" ValueChanged="ContentLayoutChanged" Disabled="@(SelectedRuleName is null)" Variant="Variant.Outlined" ShrinkLabel="true" data-test-id="@TestIdHelper.For("RssRulesContentLayout")">
                            <MudSelectItem Value="@("Default")">Use global settings</MudSelectItem>
                            <MudSelectItem Value="@("Original")">Original</MudSelectItem>
                            <MudSelectItem Value="@("Subfolder")">Create subfolder</MudSelectItem>
                            <MudSelectItem Value="@("NoSubfolder")">Don't create subfolder</MudSelectItem>
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="12">
                        <MudList T="string" SelectionMode="SelectionMode.MultiSelection" SelectedValues="SelectedFeeds" SelectedValuesChanged="SelectedFeedsChanged" CheckBoxColor="Color.Default" Disabled="@(SelectedRuleName is null)" Dense data-test-id="@TestIdHelper.For("RssRulesFeeds")">
                            <MudListSubheader>Apply Rule to Feeds</MudListSubheader>
                            @foreach (var (feed, _) in Feeds)
                            {
                                <MudListItem Value="@feed" Text="@feed" data-test-id="@TestIdHelper.For($"RssRulesFeed-{feed}")" />
                            }
                        </MudList>
                    </MudItem>
                </MudGrid>
            </MudItem>
            <MudItem xs="3">
                <MudText Class="no-wrap">Matching RSS Articles</MudText>
                <MudList T="string" ReadOnly Dense>
                    @if (MatchingArticles is not null)
                    {
                        foreach (var (feed, articles) in MatchingArticles)
                        {
                            <MudListItem Text="@feed" Expanded="true">
                                <NestedList>
                                    @foreach (var article in articles)
                                    {
                                        <MudListItem Text="@article"
                                                     data-test-id="@TestIdHelper.For($"RssRulesArticle-{article}")" />
                                    }
                                </NestedList>
                            </MudListItem>
                        }
                    }
                </MudList>
            </MudItem>
        </MudGrid>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" data-test-id="@TestIdHelper.For("RssRulesClose")">Close</MudButton>
        <MudButton Color="Color.Primary" OnClick="Submit" data-test-id="@TestIdHelper.For("RssRulesSave")">Save</MudButton>
    </DialogActions>
</MudDialog>
