@using Lantean.QBitTorrentClient.Models
@using Lantean.QBTMud.Components.UI

<MudDialog>
    <DialogContent>
        <MudGrid>
            <MudItem xs="3">
                <MudToolBar Class="px-0" Dense>
                    <MudText Class="no-wrap">@WebUiLocalizer.Translate("AutomatedRssDownloader", "Download Rules")</MudText>
                    <MudSpacer />
                    <MudIconButton Icon="@Icons.Material.Filled.Add" OnClick="AddRule" data-test-id="@TestIdHelper.For("RssRulesAdd")" />
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" OnClick="RemoveRule" Disabled="SelectedRuleName is null" data-test-id="@TestIdHelper.For("RssRulesRemove")" />
                </MudToolBar>

                <MudList T="string" SelectionMode="SelectionMode.SingleSelection" SelectedValue="SelectedRuleName" SelectedValueChanged="SelectedRuleChanged" data-test-id="@TestIdHelper.For("RssRulesList")">
                    @foreach (var (ruleName, rule) in Rules)
                    {
                        <MudListItem Icon="@((rule?.Enabled ?? true) ? Icons.Material.Filled.CheckBox : Icons.Material.Filled.CheckBoxOutlineBlank)" Text="@ruleName" Value="@ruleName" data-test-id="@TestIdHelper.For($"RssRule-{ruleName}")" />
                    }
                </MudList>
            </MudItem>
            <MudItem xs="6">
                <MudGrid>
                    <MudItem xs="12">
                        <FieldSwitch Label="@WebUiLocalizer.Translate("AutomatedRssDownloader", "Use Regular Expressions")" Value="UseRegex" ValueChanged="UseRegexChanged" Disabled="@(SelectedRuleName is null)" data-test-id="@TestIdHelper.For("RssRulesUseRegex")" />
                    </MudItem>
                    <MudItem xs="12">
                        <MudTextField T="string" Label="@WebUiLocalizer.Translate("AutomatedRssDownloader", "Must Contain:")" Value="MustContain" ValueChanged="MustContainChanged" Disabled="@(SelectedRuleName is null)" Variant="Variant.Outlined" ShrinkLabel="true" data-test-id="@TestIdHelper.For("RssRulesMustContain")" />
                    </MudItem>
                    <MudItem xs="12">
                        <MudTextField T="string" Label="@WebUiLocalizer.Translate("AutomatedRssDownloader", "Must Not Contain:")" Value="MustNotContain" ValueChanged="MustNotContainChanged" Disabled="@(SelectedRuleName is null)" Variant="Variant.Outlined" ShrinkLabel="true" data-test-id="@TestIdHelper.For("RssRulesMustNotContain")" />
                    </MudItem>
                    <MudItem xs="12">
                        <MudTextField T="string" Label="@WebUiLocalizer.Translate("AutomatedRssDownloader", "Episode Filter:")" Value="EpisodeFilter" ValueChanged="EpisodeFilterChanged" Disabled="@(SelectedRuleName is null)" Variant="Variant.Outlined" ShrinkLabel="true" data-test-id="@TestIdHelper.For("RssRulesEpisodeFilter")" />
                    </MudItem>
                    <MudItem xs="12">
                        <FieldSwitch Label="@WebUiLocalizer.Translate("AutomatedRssDownloader", "Use Smart Episode Filter")" Value="SmartFilter" ValueChanged="SmartFilterChanged" Disabled="@(SelectedRuleName is null)" data-test-id="@TestIdHelper.For("RssRulesSmartFilter")" />
                    </MudItem>
                    <MudDivider />
                    <MudItem xs="12">
                        <MudSelect T="string" Label="@WebUiLocalizer.Translate("AutomatedRssDownloader", "Assign Category:")" Value="Category" ValueChanged="CategoryChanged" Disabled="@(SelectedRuleName is null)" Variant="Variant.Outlined" ShrinkLabel="true" data-test-id="@TestIdHelper.For("RssRulesCategory")">
                            <MudSelectItem Value="@("")"></MudSelectItem>
                            @foreach (var category in Categories)
                            {
                                <MudSelectItem Value="@category">@category</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="12">
                        <MudTextField T="string" Label="@WebUiLocalizer.Translate("AutomatedRssDownloader", "Add Tags:")" Value="Tags" ValueChanged="TagsChanged" Disabled="@(SelectedRuleName is null)" Variant="Variant.Outlined" ShrinkLabel="true" data-test-id="@TestIdHelper.For("RssRulesTags")" />
                    </MudItem>
                    <MudItem xs="12">
                        <FieldSwitch Label="@WebUiLocalizer.Translate("AutomatedRssDownloader", "Save to a Different Directory")" Value="SaveToDifferentDirectory" ValueChanged="SaveToDifferentDirectoryChanged" Disabled="@(SelectedRuleName is null)" data-test-id="@TestIdHelper.For("RssRulesSaveToDifferentDirectory")" />
                    </MudItem>
                    <MudItem xs="12">
                        <PathAutocomplete Label="@WebUiLocalizer.Translate("AutomatedRssDownloader", "Save to:")"
                                          Value="@SaveTo"
                                          ValueChanged="@(value => SaveToChanged(value ?? string.Empty))"
                                          Mode="DirectoryContentMode.Directories"
                                          Disabled="@(SelectedRuleName is null || !SaveToDifferentDirectory)"
                                          data-test-id="@TestIdHelper.For("RssRulesSaveTo")" />
                    </MudItem>
                    <MudItem xs="12">
                        <MudNumericField T="int" Label="@WebUiLocalizer.Translate("AutomatedRssDownloader", "Ignore Subsequent Matches for (0 to Disable)")" Value="IgnoreDays" ValueChanged="IgnoreDaysChanged" Disabled="@(SelectedRuleName is null)" Variant="Variant.Outlined" ShrinkLabel="true" data-test-id="@TestIdHelper.For("RssRulesIgnoreDays")" />
                    </MudItem>
                    <MudItem xs="12">
                        <MudSelect T="string" Label="@WebUiLocalizer.Translate("AutomatedRssDownloader", "Add Stopped:")" Value="AddStopped" ValueChanged="AddStoppedChanged" Disabled="@(SelectedRuleName is null)" Variant="Variant.Outlined" ShrinkLabel="true" data-test-id="@TestIdHelper.For("RssRulesAddStopped")">
                            <MudSelectItem Value="@("default")">@WebUiLocalizer.Translate("AutomatedRssDownloader", "Use global settings")</MudSelectItem>
                            <MudSelectItem Value="@("always")">@WebUiLocalizer.Translate("AutomatedRssDownloader", "Always")</MudSelectItem>
                            <MudSelectItem Value="@("never")">@WebUiLocalizer.Translate("AutomatedRssDownloader", "Never")</MudSelectItem>
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="12">
                        <MudSelect T="string" Label="@WebUiLocalizer.Translate("AutomatedRssDownloader", "Torrent content layout:")" Value="ContentLayout" ValueChanged="ContentLayoutChanged" Disabled="@(SelectedRuleName is null)" Variant="Variant.Outlined" ShrinkLabel="true" data-test-id="@TestIdHelper.For("RssRulesContentLayout")">
                            <MudSelectItem Value="@("Default")">@WebUiLocalizer.Translate("AutomatedRssDownloader", "Use global settings")</MudSelectItem>
                            <MudSelectItem Value="@("Original")">@WebUiLocalizer.Translate("AutomatedRssDownloader", "Original")</MudSelectItem>
                            <MudSelectItem Value="@("Subfolder")">@WebUiLocalizer.Translate("AutomatedRssDownloader", "Create subfolder")</MudSelectItem>
                            <MudSelectItem Value="@("NoSubfolder")">@WebUiLocalizer.Translate("AutomatedRssDownloader", "Don't create subfolder")</MudSelectItem>
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="12">
                        <MudList T="string" SelectionMode="SelectionMode.MultiSelection" SelectedValues="SelectedFeeds" SelectedValuesChanged="SelectedFeedsChanged" CheckBoxColor="Color.Default" Disabled="@(SelectedRuleName is null)" Dense data-test-id="@TestIdHelper.For("RssRulesFeeds")">
                            <MudListSubheader>@WebUiLocalizer.Translate("AutomatedRssDownloader", "Apply Rule to Feeds:")</MudListSubheader>
                            @foreach (var (feed, _) in Feeds)
                            {
                                <MudListItem Value="@feed" Text="@feed" data-test-id="@TestIdHelper.For($"RssRulesFeed-{feed}")" />
                            }
                        </MudList>
                    </MudItem>
                </MudGrid>
            </MudItem>
            <MudItem xs="3">
                <MudText Class="no-wrap">@WebUiLocalizer.Translate("AutomatedRssDownloader", "Matching RSS Articles")</MudText>
                <MudList T="string" ReadOnly Dense>
                    @if (MatchingArticles is not null)
                    {
                        foreach (var (feed, articles) in MatchingArticles)
                        {
                            <MudListItem Text="@feed" Expanded="true">
                                <NestedList>
                                    @foreach (var article in articles)
                                    {
                                        <MudListItem Text="@article"
                                                     data-test-id="@TestIdHelper.For($"RssRulesArticle-{article}")" />
                                    }
                                </NestedList>
                            </MudListItem>
                        }
                    }
                </MudList>
            </MudItem>
        </MudGrid>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" data-test-id="@TestIdHelper.For("RssRulesClose")">@WebUiLocalizer.Translate("PluginSelectDlg", "Close")</MudButton>
        <MudButton Color="Color.Primary" OnClick="Submit" data-test-id="@TestIdHelper.For("RssRulesSave")">@WebUiLocalizer.Translate("HttpServer", "Save")</MudButton>
    </DialogActions>
</MudDialog>
